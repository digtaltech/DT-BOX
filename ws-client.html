<!DOCTYPE html>
<meta charset="utf-8" />
<title>WebSocket Test</title>
<header>
	<link rel="stylesheet" href="style.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
</header>
<div class="body-qr-scan">
	<div class="header-style container-fluid d-flex justify-content-center align-items-center">
		<h2>DT BOX v.0.02</h2>
	</div>
	<div class="main-content-style container">
		<div class="row">
			<div class="col border-end border-bottom border-2 border-white p-2 ">
				<h2 class="text-center mb-3">QR</h2>
				<input id="qr_data" type="text" value="https://dt-box.com" class="form-control container-fluid d-flex justify-content-center align-items-center"/><br />
				<div id="qrcode" class="container-fluid d-flex justify-content-center align-items-center mb-3">
					<!-- NONE -->
				</div>

			</div>
			<div class="col border-bottom border-2 border-white p-2">
				<h2 class="text-center">Data on Box</h2>
				<div id="output-message"></div>
			</div>
		</div>
		<div class="row">
			<div class="col border-end border-2 border-white p-2">

				<h2 class="text-center mb-4">Send data to client</h2>

				<div id="input" >
					<form onsubmit="return false" class="d-grid gap-2">
						<input id="message" class="form-control ">
						<button type="submit" onclick="doSend(document.getElementById('message').value)" class="btn btn-primary">Send</button>
					</form>
				</div>
			</div>

			<div class="col p-2">
				<h2 class="text-center">Logs</h2>
				<div id="output-log"></div>
			</div>
		</div>
	</div>

</div>
</html>
<script language="javascript" type="text/javascript">
	//var wsUri = "ws://127.0.0.1:9090/"
	var wsUri = "ws://192.168.1.40:9090/"
	var output;
	var output_message;
	var client_id

	function init() {
		output = document.getElementById("output-log")
		output_message = document.getElementById("output-message")
		uWebSocket()
	}

	function uWebSocket() {
		websocket = new WebSocket(wsUri);
		websocket.onopen = function(evt) {
			onOpen(evt)
		}
		websocket.onclose = function(evt) {
			onClose(evt)
		}
		websocket.onmessage = function(evt) {
			onMessage(evt)
		}
		websocket.onerror = function(evt) {
			onError(evt)
		}
	}

	function onOpen(evt) {
		writeToLogs("CONNECTED")
		// doSend("Hi everybody!")
	}

	function onClose(evt) {
		writeToLogs("DISCONNECTED")
	}

	function onMessage(evt) {
		var data_response = JSON.parse(evt.data)
		client_id = data_response.client_id
		console.log(client_id)
		writeToLogs('<span style="color: green;">Web Client ID = ' + data_response.web_id)
		writeToLogs('<span style="color: green;">Mobile Client ID = ' + data_response.client_id)
		writeToLogs('<span style="color: blue;">RESPONSE: ' + evt.data + '')
		// console.log("Web Client ID = " + data_response.web_id)
		// console.log(evt.data)
		qr_data.value = '{ "status": "debug", "web_id": '+data_response.web_id+', "client_id": 2, "data": "Wake the fuck up samurai !" }'
		makeCode ()
		writeMessage('<span style="color: green;">RESPONSE: ' + data_response.data + '')

		//websocket.close()
	}

	function onError(evt) {
		writeToLogs('<span style="color: red;">ERROR: ' + evt.data)
	}

	function doSend(message) {
		writeMessage("SENT: " + message)
		var data_send = {"status": "debug", "web_id": client_id, "client_id": null, "data": message}
		// var data_send = JSON.parse(message)
		writeToLogs("SENT: " + JSON.stringify(data_send))
		websocket.send(JSON.stringify(data_send))
	}

	function writeMessage(message) {

		var pre = document.createElement("p")
		pre.style.wordWrap = "break-word"
		pre.innerHTML = message

		output_message.appendChild(pre)
	}

	function writeToLogs(message) {

		var pre = document.createElement("p")
		pre.style.wordWrap = "break-word"
		pre.innerHTML = message
		output.appendChild(pre)
	}

	window.addEventListener("load", init, false)

	// QR
	var qrcode = new QRCode("qrcode");

function makeCode () {
  var elText = document.getElementById("qr_data");

  if (!elText.value) {
    alert("Input a text");
    elText.focus();
    return;
  }

  qrcode.makeCode(elText.value);
}

makeCode();

$("#qr_data").
  on("blur", function () {
    makeCode();
  }).
  on("keydown", function (e) {
    if (e.keyCode == 13) {
      makeCode();
    }
  });
</script>
